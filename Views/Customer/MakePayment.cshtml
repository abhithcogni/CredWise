@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@model CredWise_Trail.Controllers.MakePaymentViewModel // Add this line to specify the model type

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make Payment - Customer Portal</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
            line-height: 1.6;
        }

        /* Page Header */
        .h2.fw-bold {
            color: #2c3e50;
        }

        /* Cards */
        .payment-summary-card,
        .make-payment-card {
            border: none;
            border-radius: 0.85rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .07);
            background-color: #ffffff;
            overflow: hidden;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

            .payment-summary-card:hover,
            .make-payment-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 12px 30px rgba(0, 0, 0, .09);
            }

        .card-header {
            background-color: #0A2463;
            color: #ffffff;
            border-bottom: none;
            font-weight: 600;
            font-size: 1.05rem;
            /* Slightly smaller than admin header */
            padding: 0.9rem 1.25rem;
            letter-spacing: 0.3px;
        }

            .card-header .fas {
                margin-right: 0.6rem;
            }

        .summary-label {
            color: #6c757d;
            /* Muted text for labels */
            font-size: 0.9rem;
        }

        .summary-value {
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* Form Elements */
        .form-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-control,
        .form-select {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
        }

            .form-control:focus,
            .form-select:focus {
                border-color: #0A2463;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .15);
            }

        .input-group-text {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            font-size: 0.9rem;
        }

        /* Buttons */
        .stylish-button {
            padding: 0.65rem 1.5rem;
            font-weight: 500;
            border-radius: 0.375rem;
            letter-spacing: 0.3px;
            transition: all 0.2s ease-in-out;
        }

            .stylish-button .fas {
                margin-right: 0.5rem;
                transition: transform 0.2s ease-in-out;
            }

            .stylish-button:hover .fas {
                transform: scale(1.1);
            }

        .btn-primary.stylish-button:hover {
            box-shadow: 0 4px 10px rgba(13, 110, 253, .25);
        }

        /* Payment status icons */
        .status-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .text-success .status-icon {
            color: #198754;
        }

        .text-danger .status-icon {
            color: #dc3545;
        }

        #proceedToPayButton {
            background-color: #3E92CC;
        }

            #proceedToPayButton:hover {
                background-color: #0A2463;
                border-color: white;
            }

        .form-check-label a {
            color: #3E92CC;
            text-decoration: none;
        }

            .form-check-label a:hover {
                text-decoration: underline;
                color: #0A2463;
            }

        #confirmPayButton {
            background-color: #3E92CC;
        }

            #confirmPayButton:hover {
                background-color: #0A2463;
                border-color: white;
            }

        #paymentStatusModalHeader {
            background-color: #0A2463 !important;
        }

        #paymentStatusCloseButton {
            background-color: #3E92CC;
        }

            #paymentStatusCloseButton:hover {
                background-color: #0A2463;
                border-color: white;
            }
    </style>
</head>

<body>
    <div class="d-flex" id="wrapper">
        <div id="page-content-wrapper" class="w-100">


            <div class="container-fluid p-4 p-md-5">
                <div class="mb-4">
                    <h1 class="h2 fw-bold">Make a Payment</h1>
                    <p class="text-muted" id="paymentPageSubtitle">Securely pay your outstanding loan amount.</p>
                </div>

                <div class="row">
                    <div class="col-lg-7 col-xl-6 mb-4 mb-lg-0">
                        <div class="card payment-summary-card">
                            <div class="card-header">
                                <i class="fas fa-file-invoice-dollar me-2"></i>Payment Due Summary
                            </div>
                            <div class="card-body p-4">
                                <h5 class="card-title" id="loanProductName"></h5>
                                <p class="card-text text-muted" id="loanShortDescription"></p>
                                <hr>
                                <div class="row mb-2">
                                    <div class="col-6 summary-label">Amount Due:</div>
                                    <div class="col-6 summary-value fw-bold fs-5 text-danger" id="amountDue"></div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6 summary-label">Due Date:</div>
                                    <div class="col-6 summary-value" id="dueDate"></div>
                                </div>
                                <div class="row">
                                    <div class="col-6 summary-label">Outstanding Balance:</div>
                                    <div class="col-6 summary-value" id="outstandingBalance"></div>
                                </div>
                                <div id="paymentSuccessMessage" class="alert alert-success mt-3 d-none" role="alert">
                                    <i class="fas fa-check-circle me-2"></i>Payment successful! Your next payment
                                    details will be updated shortly.
                                </div>
                                <div id="noPaymentDueMessage" class="alert alert-info mt-3 d-none" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>No payment is currently due for this loan.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5 col-xl-6">
                        <div class="card make-payment-card">
                            <div class="card-header">
                                <i class="fas fa-credit-card me-2"></i>Payment Details
                            </div>
                            <div class="card-body p-4">
                                <form id="paymentForm">
                                    <div class="mb-3">
                                        <label for="paymentAmount" class="form-label">Payment Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="paymentAmount"
                                                   name="paymentAmount" step="0.01" required>
                                        </div>
                                        <div class="form-text">
                                            You can pay the full amount or a partial amount (if
                                            allowed).
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="paymentMethod" class="form-label">Payment Method</label>
                                        <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                                            <option value="" selected disabled>Select a payment method...</option>
                                            <option value="saved_bank_****1234">Saved Bank Account (****1234)</option>
                                            <option value="saved_card_****5678">Saved Credit Card (****5678)</option>
                                            <option value="new_bank">New Bank Account</option>
                                            <option value="new_card">New Credit/Debit Card</option>
                                        </select>
                                    </div>

                                    <div id="newPaymentMethodFields" class="d-none mt-3 border p-3 rounded">
                                        <p class="fw-medium small">Enter New Payment Details:</p>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm"
                                                   placeholder="Card Number / Account Number">
                                        </div>
                                        <div class="row gx-2">
                                            <div class="col-6">
                                                <input type="text" class="form-control form-control-sm"
                                                       placeholder="MM/YY / Routing">
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control form-control-sm"
                                                       placeholder="CVC">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-check mt-3 mb-3">
                                        <input class="form-check-input" type="checkbox" value="" id="termsAndConditions"
                                               required>
                                        <label class="form-check-label small" for="termsAndConditions">
                                            I agree to the <a href="#">Terms and Conditions</a> of this payment.
                                        </label>
                                    </div>

                                    <button type="submit" class="btn btn-primary w-100 stylish-button"
                                            id="proceedToPayButton">
                                        <i class="fas fa-arrow-circle-right me-2"></i>Proceed to Pay
                                    </button>
                                    <button type="button" class="btn btn-success w-100 stylish-button mt-2 d-none"
                                            id="paymentCompletedButton" disabled>
                                        <i class="fas fa-check-circle me-2"></i>Payment Completed
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="paymentConfirmationModal" tabindex="-1"
                 aria-labelledby="paymentConfirmationModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="paymentConfirmationModalLabel">
                                <i class="fas fa-question-circle me-2 text-primary"></i>Confirm Payment
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Please review your payment details:</p>
                            <ul class="list-unstyled">
                                <li><strong>Loan:</strong> <span id="confirmLoanName"></span></li>
                                <li>
                                    <strong>Payment Amount:</strong> <span id="confirmPaymentAmount"
                                                                           class="fw-bold"></span>
                                </li>
                                <li><strong>Payment Method:</strong> <span id="confirmPaymentMethod"></span></li>
                            </ul>
                            <p class="text-muted small mt-3">
                                By clicking "Confirm & Pay", you authorize this payment.
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <button type="button" class="btn btn-primary" id="confirmPayButton">
                                <i class="fas fa-shield-alt me-2"></i>Confirm & Pay
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="paymentStatusModal" tabindex="-1" aria-labelledby="paymentStatusModalLabel"
                 aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header" id="paymentStatusModalHeader">
                            <h5 class="modal-title" id="paymentStatusModalLabel">Processing Payment...</h5>
                        </div>
                        <div class="modal-body text-center py-4">
                            <div id="paymentProcessingSpinner" class="mb-3">
                                <div class="spinner-border text-primary" role="status"
                                     style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Please wait, we are securely processing your payment.</p>
                            </div>
                            <div id="paymentStatusResult" class="d-none">
                            </div>
                        </div>
                        <div class="modal-footer d-none" id="paymentStatusModalFooter">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                                    id="paymentStatusCloseButton">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script>
        $(document).ready(function () {
            // --- Initial Loan Data (Populated from server-side Model) ---
            // The @Model syntax below injects C# model data directly into JavaScript
            let loanData = {
                loanId: @Model.LoanId,
                productName: "@Html.Raw(Model.ProductName)", // Html.Raw to prevent double-encoding
                shortDescription: "@Html.Raw(Model.ShortDescription)",
                amountDue: @Model.AmountDue, // This should be the current EMI amount or remaining due
                // Format date for display, handle null if no due date
                dueDate: "@(Model.DueDate.HasValue ? Model.DueDate.Value.ToString("MMMM d, yyyy") : "N/A")",
                outstandingBalance: @Model.OutstandingBalance,
                minPayment: @Model.MinPayment, // This is the EMI
                isPaymentDue: @Model.IsPaymentDue.ToString().ToLower() // C# bool to JS boolean string
            };

            const confirmationModal = new bootstrap.Modal(document.getElementById('paymentConfirmationModal'));
            const statusModal = new bootstrap.Modal(document.getElementById('paymentStatusModal'));

            // --- Populate Initial Data ---
            function populateLoanDetails() {
                // Always populate these common fields
                $('#loanProductName').text(loanData.productName);
                $('#loanShortDescription').text(loanData.shortDescription);
                $('#outstandingBalance').text('$' + loanData.outstandingBalance.toFixed(2));


                if (loanData.isPaymentDue) {
                    $('#amountDue').text('$' + loanData.amountDue.toFixed(2)).removeClass('text-success').addClass('text-danger');
                    $('#dueDate').text(loanData.dueDate);
                    $('#paymentAmount').val(loanData.amountDue.toFixed(2)); // Pre-fill with amount due

                    $('#paymentForm').show();
                    $('#proceedToPayButton').removeClass('d-none');
                    $('#paymentCompletedButton').addClass('d-none');
                    $('#noPaymentDueMessage').addClass('d-none');
                    $('#paymentSuccessMessage').addClass('d-none'); // Hide success message on reload
                    $('#paymentPageSubtitle').text('Securely pay your outstanding loan amount.');
                } else {
                    $('#amountDue').text('$0.00').removeClass('text-danger').addClass('text-success'); // No amount due, green
                    $('#dueDate').text('N/A'); // Or next due date if available

                    $('#paymentForm').hide(); // Hide the form
                    $('#noPaymentDueMessage').removeClass('d-none'); // Show info message
                    $('#proceedToPayButton').addClass('d-none');
                    $('#paymentCompletedButton').addClass('d-none'); // Ensure this is also hidden if no payment due
                    $('#paymentSuccessMessage').addClass('d-none'); // Hide success message
                    $('#paymentPageSubtitle').text('View your loan summary. No payment is currently due.');
                }
            }

            populateLoanDetails(); // Call this function on page load to display initial data

            // --- Handle Payment Method Change ---
            $('#paymentMethod').on('change', function () {
                if ($(this).val() === 'new_bank' || $(this).val() === 'new_card') {
                    $('#newPaymentMethodFields').removeClass('d-none');
                } else {
                    $('#newPaymentMethodFields').addClass('d-none');
                }
            });

            // --- Handle Form Submission (Proceed to Pay) ---
            $('#paymentForm').on('submit', function (e) {
                e.preventDefault();
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    $(this).addClass('was-validated');
                    return;
                }
                $(this).removeClass('was-validated');

                const paymentAmount = parseFloat($('#paymentAmount').val());
                const paymentMethodText = $('#paymentMethod option:selected').text();

                // Client-side validation for amount:
                // Only validate against minPayment if a payment is actually due
                if (loanData.isPaymentDue) {
                    if (paymentAmount < loanData.minPayment) {
                        alert(`Minimum payment amount is $${loanData.minPayment.toFixed(2)}.`);
                        $('#paymentAmount').addClass('is-invalid');
                        return;
                    }
                }

                // Payment amount cannot exceed outstanding balance (always true)
                if (paymentAmount > loanData.outstandingBalance) {
                    alert(`Payment amount cannot exceed the outstanding balance of $${loanData.outstandingBalance.toFixed(2)}.`);
                    $('#paymentAmount').addClass('is-invalid');
                    return;
                }

                $('#paymentAmount').removeClass('is-invalid'); // Clear invalid state if valid

                $('#confirmLoanName').text(loanData.productName);
                $('#confirmPaymentAmount').text('$' + paymentAmount.toFixed(2));
                $('#confirmPaymentMethod').text(paymentMethodText);

                confirmationModal.show();
            });

            // --- Handle Actual Payment Confirmation (AJAX Call to Backend) ---
            $('#confirmPayButton').on('click', function () {
                confirmationModal.hide();

                // Show processing modal
                $('#paymentStatusModalLabel').text('Processing Payment...');
                $('#paymentStatusModalHeader').removeClass('bg-success bg-danger text-white').addClass('bg-primary text-white');
                $('#paymentProcessingSpinner').removeClass('d-none');
                $('#paymentStatusResult').addClass('d-none');
                $('#paymentStatusModalFooter').addClass('d-none');
                statusModal.show();

                const paymentAmount = parseFloat($('#paymentAmount').val());
                const paymentMethod = $('#paymentMethod').val(); // Get the actual value for backend


                // Make AJAX call to your backend
                $.ajax({
                    url: '/Customer/ProcessPayment', // Adjust to your actual controller/action path
                    type: 'POST',
                    contentType: 'application/json', // Indicate sending JSON
                    data: JSON.stringify({ // Stringify the JavaScript object to JSON
                        loanId: loanData.loanId, // Send the loan ID from your initial data
                        paymentAmount: paymentAmount,
                        paymentMethod: paymentMethod
                        // Add any other new payment method fields here if 'new_bank'/'new_card' selected
                        // e.g., CardNumber: $('#cardNumberField').val()
                    }),
                    success: function (response) {
                        $('#paymentProcessingSpinner').addClass('d-none');
                        $('#paymentStatusResult').removeClass('d-none');
                        $('#paymentStatusModalFooter').removeClass('d-none');

                        if (response.success) {
                            $('#paymentStatusModalHeader').removeClass('bg-primary').addClass('bg-success text-white');
                            $('#paymentStatusModalLabel').text('Payment Successful!');
                            $('#paymentStatusResult').html(`
                                <div class="text-success"><i class="fas fa-check-circle status-icon"></i></div>
                                <p class="fs-5">Your payment of <strong>$${paymentAmount.toFixed(2)}</strong> has been processed successfully.</p>
                                <p>Transaction ID: ${response.transactionId}</p>
                            `);
                            $('#paymentStatusCloseButton').removeClass('btn-danger').addClass('btn-primary');

                            // --- Update local loanData based on successful payment ---
                            loanData.outstandingBalance = parseFloat((loanData.outstandingBalance - paymentAmount).toFixed(2));
                            loanData.amountDue = 0; // Assume current due is cleared by a successful payment
                            loanData.isPaymentDue = false; // Payment is now processed for this cycle

                            // Simulate the next due date if the current payment covered the EMI
                            // In a real app, the server would send the *actual* new NextDueDate
                            let nextDueDate = new Date(loanData.dueDate); // Use the current dueDate as a base
                            if (!isNaN(nextDueDate.getTime())) { // Check if valid date
                                nextDueDate.setMonth(nextDueDate.getMonth() + 1); // Advance by one month
                                loanData.dueDate = nextDueDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                            }


                            populateLoanDetails(); // Re-render the summary card with updated data
                            $('#paymentForm').hide(); // Hide the payment form
                            $('#paymentSuccessMessage').removeClass('d-none'); // Show success message on main page
                            $('#proceedToPayButton').addClass('d-none');
                            $('#paymentCompletedButton').removeClass('d-none').text('Payment Successful').prop('disabled', true); // Show "Payment Completed" button

                        } else {
                            $('#paymentStatusModalHeader').removeClass('bg-primary').addClass('bg-danger text-white');
                            $('#paymentStatusModalLabel').text('Payment Failed');
                            $('#paymentStatusResult').html(`
                                <div class="text-danger"><i class="fas fa-times-circle status-icon"></i></div>
                                <p class="fs-5">Your payment of <strong>$${paymentAmount.toFixed(2)}</strong> could not be processed.</p>
                                <p>Reason: ${response.message || 'An unknown error occurred.'}</p>
                                <p>${response.reason || 'Please try again or contact support.'}</p>
                            `);
                            $('#paymentStatusCloseButton').removeClass('btn-primary').addClass('btn-danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        $('#paymentProcessingSpinner').addClass('d-none');
                        $('#paymentStatusResult').removeClass('d-none');
                        $('#paymentStatusModalFooter').removeClass('d-none');

                        let errorMessage = "An unexpected error occurred.";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            try {
                                let res = JSON.parse(xhr.responseText);
                                errorMessage = res.message || errorMessage;
                            } catch (e) {
                                errorMessage = xhr.responseText;
                            }
                        }

                        $('#paymentStatusModalHeader').removeClass('bg-primary').addClass('bg-danger text-white');
                        $('#paymentStatusModalLabel').text('Payment Error');
                        $('#paymentStatusResult').html(`
                            <div class="text-danger"><i class="fas fa-times-circle status-icon"></i></div>
                            <p class="fs-5">There was an issue processing your payment.</p>
                            <p>Error: ${errorMessage}</p>
                            <p>Please try again or contact support.</p>
                        `);
                        $('#paymentStatusCloseButton').removeClass('btn-primary').addClass('btn-danger');
                    }
                });
            });

            // Clear validation on input
            $('#paymentAmount').on('input', function () {
                $(this).removeClass('is-invalid');
            });
            $('#paymentForm select, #paymentForm input[type="checkbox"]').on('change', function () {
                $(this).removeClass('is-invalid');
                $('#paymentForm').removeClass('was-validated'); // Reset overall form validation state on interaction
            });
        });
    </script>
</body>

</html>